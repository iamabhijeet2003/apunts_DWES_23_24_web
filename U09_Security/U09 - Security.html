<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-UK" xml:lang="en-UK" >

<head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />     <meta name="author" content="Fidel Oltra, Ricardo Sánchez" />        <title>Unit 9. Security.</title>
    <style>
        code{white-space: pre-wrap;}
        span.smallcaps{font-variant: small-caps;}
        div.columns{display: flex; gap: min(4vw, 1.5em);}
        div.column{flex: auto; overflow-x: auto;}
        div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
        /* The extra [class] is a hack that increases specificity enough to
           override a similar rule in reveal.js */
        ul.task-list[class]{list-style: none;}
        ul.task-list li input[type="checkbox"] {
          font-size: inherit;
          width: 0.8em;
          margin: 0 0.8em 0.2em -1.6em;
          vertical-align: middle;
        }
        .display.math{display: block; text-align: center; margin: 0.5rem auto;}
        /* CSS for syntax highlighting */
        pre > code.sourceCode { white-space: pre; position: relative; }
        pre > code.sourceCode > span { line-height: 1.25; }
        pre > code.sourceCode > span:empty { height: 1.2em; }
        .sourceCode { overflow: visible; }
        code.sourceCode > span { color: inherit; text-decoration: inherit; }
        div.sourceCode { margin: 1em 0; }
        pre.sourceCode { margin: 0; }
        @media screen {
        div.sourceCode { overflow: auto; }
        }
        @media print {
        pre > code.sourceCode { white-space: pre-wrap; }
        pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
        }
        pre.numberSource code
          { counter-reset: source-line 0; }
        pre.numberSource code > span
          { position: relative; left: -4em; counter-increment: source-line; }
        pre.numberSource code > span > a:first-child::before
          { content: counter(source-line);
            position: relative; left: -1em; text-align: right; vertical-align: baseline;
            border: none; display: inline-block;
            -webkit-touch-callout: none; -webkit-user-select: none;
            -khtml-user-select: none; -moz-user-select: none;
            -ms-user-select: none; user-select: none;
            padding: 0 4px; width: 4em;
            color: #aaaaaa;
          }
        pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
        div.sourceCode
          {  background-color: #f8f8f8; }
        @media screen {
        pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
        }
        code span.al { color: #ef2929; } /* Alert */
        code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
        code span.at { color: #204a87; } /* Attribute */
        code span.bn { color: #0000cf; } /* BaseN */
        code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
        code span.ch { color: #4e9a06; } /* Char */
        code span.cn { color: #8f5902; } /* Constant */
        code span.co { color: #8f5902; font-style: italic; } /* Comment */
        code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
        code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
        code span.dt { color: #204a87; } /* DataType */
        code span.dv { color: #0000cf; } /* DecVal */
        code span.er { color: #a40000; font-weight: bold; } /* Error */
        code span.ex { } /* Extension */
        code span.fl { color: #0000cf; } /* Float */
        code span.fu { color: #204a87; font-weight: bold; } /* Function */
        code span.im { } /* Import */
        code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
        code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
        code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
        code span.ot { color: #8f5902; } /* Other */
        code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
        code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
        code span.ss { color: #4e9a06; } /* SpecialString */
        code span.st { color: #4e9a06; } /* String */
        code span.va { color: #000000; } /* Variable */
        code span.vs { color: #4e9a06; } /* VerbatimString */
        code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
    </style>
        <link rel="stylesheet" href="../web_template/aqua.css" />  
    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
      
</head>

<body>
    <div id="content">
                 <header id="title-block-header">
            <h1 class="title">Unit 9. Security.</h1>
            <!---->
            <!--         <p class="author">Fidel Oltra, Ricardo
Sánchez</p>
         -->
                    </header>
                 <nav id="TOC" role="doc-toc">
            <div class="navContainer">
                                <h2 id="toc-title">Index</h2>
                 <ul>
<li><a href="#security" id="toc-security"><span
class="toc-section-number">1</span> Security</a></li>
<li><a href="#managing-users" id="toc-managing-users"><span
class="toc-section-number">2</span> Managing users</a>
<ul>
<li><a href="#register" id="toc-register"><span
class="toc-section-number">2.1</span> Register</a></li>
<li><a href="#login" id="toc-login"><span
class="toc-section-number">2.2</span> Login</a></li>
<li><a href="#tracking-user-and-logging-out"
id="toc-tracking-user-and-logging-out"><span
class="toc-section-number">2.3</span> Tracking user and logging
out</a></li>
<li><a href="#permissions" id="toc-permissions"><span
class="toc-section-number">2.4</span> Permissions</a></li>
</ul></li>
</ul>
            </div>
        </nav>
                <main>
            <h1 data-number="1" id="security"><span
            class="header-section-number">1</span> Security</h1>
            <p>In this unit we’ll see how to apply basic security to our
            application. There are 2 main mechanism of security:</p>
            <ul>
            <li><strong>Authentication</strong>: how the users can
            access the app and where their credentials are stored.</li>
            <li><strong>Authorization</strong>: once the user has been
            logged in correctly, determine their
            <strong>permissions</strong> and what resources can access
            and which can’t.</li>
            </ul>
            <p>In this unit we will use the Login App of the previous
            examples to show how to do all the stuff. We will use the
            next scripts:</p>
            <ul>
            <li><code>login_form.php</code>: the existent script, used
            to manage logins.</li>
            <li><code>register_form.php</code>: a new script to
            auto-register users.</li>
            <li><code>login_access_form.php</code>: a new script to log
            in the users.</li>
            </ul>
            <h1 data-number="2" id="managing-users"><span
            class="header-section-number">2</span> Managing users</h1>
            <p>To implement the user’s authentication in our app, we
            need two more forms, one for registering and another one for
            logging.</p>
            <h2 data-number="2.1" id="register"><span
            class="header-section-number">2.1</span> Register</h2>
            <p>The first thing is to make a registration form. We will
            reuse the same login form of <code>login_form.php</code>
            (you can do a partial with the form code and include it in
            <code>register_form.php</code> and in
            <code>login_form.php</code>).</p>
            <p>Make a new script called <code>register_form.php</code>
            with the registration code. We don’t need the
            <code>id</code> field and only need a ‘Register’ button.
            Also, make sure that the password field is of type
            <strong>password</strong>:</p>
            <figure>
            <img src="images/u09-01.png" width="350"
            alt="Register form" />
            <figcaption aria-hidden="true">Register form</figcaption>
            </figure>
            <p>When the ‘Register’ button is pressed, we send the data
            to the same form with the POST method a do the same
            validations of the unit 4 (you can use the validation class
            method of Unit 8 if you want). But here we add an additional
            check: if the email already exists in the database, we show
            a new error message:</p>
            <figure>
            <img src="images/u09-02.png" width="350"
            alt="Existent email" />
            <figcaption aria-hidden="true">Existent email</figcaption>
            </figure>
            <p>To do this check, we need to create a new static method
            in the <code>LoginDao</code> class:</p>
            <div class="sourceCode" id="cb1"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">function</span> searchByEmail(<span class="va">$object</span>)<span class="ot">:</span> <span class="dt">int</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$conn</span> <span class="op">=</span> <span class="cn">D</span>BConnection::connectDB()<span class="ot">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">is_null</span>(<span class="va">$conn</span>)) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">$stmt</span> <span class="op">=</span> <span class="va">$conn</span>-&gt;prepare(<span class="st">&quot;SELECT email FROM logins WHERE email=:email&quot;</span>)<span class="ot">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">$stmt</span>-&gt;execute([<span class="st">&#39;email&#39;</span>=&gt;<span class="va">$object</span>-&gt;getEmail()])<span class="ot">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">$stmt</span>-&gt;rowCount()<span class="ot">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="ot">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>And then call it from <code>register_form.php</code>:</p>
            <div class="sourceCode" id="cb2"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="kw">empty</span>(<span class="fu">trim</span>(<span class="fu">strip_tags</span>(<span class="va">$_POST</span>[<span class="st">&#39;email&#39;</span>])))) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$emailErr</span> <span class="op">=</span> <span class="st">&quot;* Email is required&quot;</span><span class="ot">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">$err</span> <span class="op">=</span> <span class="kw">true</span><span class="ot">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">$login</span>-&gt;setEmail(<span class="fu">trim</span>(<span class="fu">strip_tags</span>(<span class="va">$_POST</span>[<span class="st">&#39;email&#39;</span>])))<span class="ot">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">$_SESSION</span>[<span class="st">&#39;email&#39;</span>] <span class="op">=</span> <span class="va">$login</span>-&gt;getEmail()<span class="ot">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//Check if the email is well-formed</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">filter_var</span>(<span class="va">$login</span>-&gt;getEmail()<span class="ot">,</span> <span class="cn">FILTER_VALIDATE_EMAIL</span>)) {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">$emailErr</span> <span class="op">=</span> <span class="st">&quot;* Invalid email format&quot;</span><span class="ot">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">$err</span> <span class="op">=</span> <span class="kw">true</span><span class="ot">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//Check if the email exists in the database</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">elseif</span> (<span class="cn">L</span>oginDao::searchByEmail(<span class="va">$login</span>) <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">$emailErr</span> <span class="op">=</span> <span class="st">&quot;* Email already exists&quot;</span><span class="ot">;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">$err</span> <span class="op">=</span> <span class="kw">true</span><span class="ot">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>Once all the validation are passed, we add the new login
            and password to the database, but before, we need to hash
            the password using the functions of the Unit 6 point 7:</p>
            <div class="sourceCode" id="cb3"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span><span class="va">$err</span>) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_POST</span>[<span class="st">&#39;submit&#39;</span>]) ){</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//New login</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>            <span class="va">$login</span>-&gt;setPassword(<span class="fu">password_hash</span>(<span class="va">$login</span>-&gt;getPassword()<span class="ot">,</span> <span class="cn">PASSWORD_DEFAULT</span>))<span class="ot">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>            <span class="cn">L</span>oginDao::insert(<span class="va">$login</span>)<span class="ot">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">$opMsg</span> <span class="op">=</span> <span class="st">&quot;Register successful&quot;</span><span class="ot">;</span><span class="co">//If no errors, make a new empty login to clear the fields</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">$login</span> <span class="op">=</span> <span class="kw">new</span> <span class="cn">L</span>ogin()<span class="ot">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (<span class="bu">Exception</span> <span class="va">$e</span>) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">echo</span> <span class="st">&quot;Error inserting login: &quot;</span> <span class="op">.</span> <span class="va">$e</span>-&gt;getMessage()<span class="ot">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>If you go to <code>logins_list.php</code> you can see the
            new login hashed:</p>
            <figure>
            <img src="images/u09-03.png"
            alt="Hashed password in logins list" />
            <figcaption aria-hidden="true">Hashed password in logins
            list</figcaption>
            </figure>
            <h2 data-number="2.2" id="login"><span
            class="header-section-number">2.2</span> Login</h2>
            <p>Once a user is registered, it need a login form to be
            authenticated. We will create the
            <code>login_access_form.php</code> to do that (remember that
            <code>login_form.php</code> is for managing the login
            data):</p>
            <figure>
            <img src="images/u09-04.png" width="350" alt="Login form" />
            <figcaption aria-hidden="true">Login form</figcaption>
            </figure>
            <p>In this form, once the basic validation is done, we need
            to check if both the email and password exist and are
            correct. If they don’t match, we show only an error message
            for security reasons. First of all, let’s create a new
            method in <code>LoginDao</code> to check if the stored
            credentials are valid, using the
            <code>password_verify</code> method seen on Unit 6:</p>
            <div class="sourceCode" id="cb4"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">function</span> checkCredential(<span class="va">$clearPassword</span><span class="ot">,</span> <span class="va">$object</span>)<span class="ot">:</span> <span class="dt">bool</span><span class="op">|</span><span class="dt">int</span> {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$conn</span> <span class="op">=</span> <span class="cn">D</span>BConnection::connectDB()<span class="ot">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">is_null</span>(<span class="va">$conn</span>)) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">$stmt</span> <span class="op">=</span> <span class="va">$conn</span>-&gt;prepare(<span class="st">&quot;SELECT * FROM logins WHERE email=:email&quot;</span>)<span class="ot">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">$stmt</span>-&gt;setFetchMode(<span class="bu">PDO</span>::<span class="cn">FETCH_CLASS</span> <span class="op">|</span> <span class="bu">PDO</span>::<span class="cn">FETCH_PROPS_LATE</span><span class="ot">,</span> <span class="st">&#39;Login&#39;</span>)<span class="ot">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">$stmt</span>-&gt;execute([<span class="st">&#39;email&#39;</span>=&gt;<span class="va">$object</span>-&gt;getEmail()])<span class="ot">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">$login</span> <span class="op">=</span> <span class="va">$stmt</span>-&gt;fetch()<span class="ot">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="va">$login</span> <span class="op">&amp;&amp;</span> <span class="fu">password_verify</span>(<span class="va">$clearPassword</span><span class="ot">,</span> <span class="va">$login</span>-&gt;getPassword())){</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">//Returns the id login if successful</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">$login</span>-&gt;getId()<span class="ot">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="ot">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="ot">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>Then, in <code>login_access_form.php</code>, use the new
            method to check if the credentials match those stored in the
            DB. If they are, store the user’s id in a session variable
            in order to know in other pages if the user is authenticated
            (remember to call <code>session_start()</code> at the
            beginning of the script) and redirect to the
            <code>login_form.php</code> script:</p>
            <div class="sourceCode" id="cb5"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span><span class="va">$err</span>) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_POST</span>[<span class="st">&#39;submit&#39;</span>]) ){</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>            <span class="va">$idLogin</span> <span class="op">=</span> <span class="cn">L</span>oginDao::checkCredential(<span class="va">$clearPassword</span><span class="ot">,</span> <span class="va">$login</span>)<span class="ot">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="va">$idLogin</span>){</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                <span class="va">$opMsg</span> <span class="op">=</span> <span class="st">&quot;Login successful&quot;</span><span class="ot">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                <span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>] <span class="op">=</span> <span class="va">$idLogin</span><span class="ot">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">header</span>(<span class="st">&#39;Location: login_form.php&#39;</span>)<span class="ot">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                <span class="va">$opMsg</span> <span class="op">=</span> <span class="st">&quot;Login failed&quot;</span><span class="ot">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">$login</span> <span class="op">=</span> <span class="kw">new</span> <span class="cn">L</span>ogin()<span class="ot">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (<span class="bu">Exception</span> <span class="va">$e</span>) {</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">echo</span> <span class="st">&quot;Error checking login: &quot;</span> <span class="op">.</span> <span class="va">$e</span>-&gt;getMessage()<span class="ot">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <h2 data-number="2.3"
            id="tracking-user-and-logging-out"><span
            class="header-section-number">2.3</span> Tracking user and
            logging out</h2>
            <p>Once the user is authenticated, we can check if it is
            logged in on each script using the session variable
            <code>'user_id'</code>. Make a new partial, named
            <code>nav_bar.part.php</code> to be included at the top of
            each page with that shows the user’s email:</p>
            <div class="sourceCode" id="cb6"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;?php</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">require_once</span> <span class="cn">__DIR__</span> <span class="op">.</span> <span class="st">&#39;/../models/Login.php&#39;</span><span class="ot">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">require_once</span> <span class="cn">__DIR__</span> <span class="op">.</span> <span class="st">&#39;/../models/LoginDao.php&#39;</span><span class="ot">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">$welcomeMessage</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="ot">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])) {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">$user</span> <span class="op">=</span> <span class="cn">L</span>oginDao::select(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])<span class="ot">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">is_null</span>(<span class="va">$user</span>)) {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">$userEmail</span> <span class="op">=</span> <span class="cn">L</span>oginDao::select(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])-&gt;getEmail() <span class="op">??</span> <span class="st">&#39;&#39;</span><span class="ot">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">$welcomeMessage</span> <span class="op">=</span> <span class="st">&quot;Welcome </span><span class="va">$userEmail</span><span class="st">&quot;</span><span class="ot">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">?&gt;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> nav_bar<span class="op">.</span>part<span class="op">.</span>php <span class="op">-</span>-&gt;</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>nav<span class="op">&gt;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>span<span class="op">&gt;</span> <span class="op">&lt;</span><span class="ot">?</span><span class="op">=</span> <span class="va">$welcomeMessage</span> <span class="kw">?&gt;</span> <span class="op">&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>nav<span class="op">&gt;</span></span></code></pre></div>
            <p>Then, include it in <code>login_form.php</code> and in
            <code>login_list.php</code> (remember to call
            <code>session_start()</code> at the beginning of the
            script):</p>
            <div class="sourceCode" id="cb7"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// login_form.php</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>body<span class="op">&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ot">?</span>php <span class="kw">include</span> <span class="cn">__DIR__</span> <span class="op">.</span> <span class="st">&#39;/partials/nav_bar.part.php&#39;</span><span class="ot">;</span> <span class="kw">?&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>h1<span class="op">&gt;</span><span class="cn">E</span>dit login<span class="op">&lt;/</span>h1<span class="op">&gt;</span></span></code></pre></div>
            <p>In <code>login_form.php</code>, we can get the login data
            using the <code>id</code> and, then, pass it to the
            form:</p>
            <div class="sourceCode" id="cb8"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">//Read id from login_list</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="va">$_SERVER</span>[<span class="st">&#39;REQUEST_METHOD&#39;</span>] <span class="op">==</span> <span class="st">&quot;GET&quot;</span>) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">empty</span>(<span class="va">$_REQUEST</span>[<span class="st">&quot;id&quot;</span>])) {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">$login</span> <span class="op">=</span> <span class="cn">L</span>oginDao::select(<span class="va">$_REQUEST</span>[<span class="st">&#39;id&#39;</span>])<span class="ot">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Read id from session</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])){</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">$login</span> <span class="op">=</span> <span class="cn">L</span>oginDao::select(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])<span class="ot">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>The next step is to implement a method to logging out the
            user. In <code>nav_bar.part.php</code> add a link only if
            the user is authenticated:</p>
            <div class="sourceCode" id="cb9"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!--</span> nav_bar<span class="op">.</span>part<span class="op">.</span>php <span class="op">-</span>-&gt;</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>nav<span class="op">&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>span<span class="op">&gt;</span> <span class="op">&lt;</span><span class="ot">?</span><span class="op">=</span> <span class="va">$welcomeMessage</span> <span class="kw">?&gt;</span> <span class="op">&lt;/</span>span<span class="op">&gt;</span> <span class="op">|</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>span<span class="op">&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span><span class="ot">?</span>php</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])) {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">echo</span> <span class="st">&quot;&lt;a href=&#39;logout.php&#39;&gt;Logout&lt;/a&gt;&quot;</span><span class="ot">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">?&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>nav<span class="op">&gt;</span></span></code></pre></div>
            <p>The target, <code>logout.php</code>, simply deletes the
            session variable and redirect to the login access form:</p>
            <div class="sourceCode" id="cb10"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;?php</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">session_start</span>()<span class="ot">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])<span class="ot">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">header</span>(<span class="st">&#39;Location: login_access_form.php&#39;</span>)<span class="ot">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <h2 data-number="2.4" id="permissions"><span
            class="header-section-number">2.4</span> Permissions</h2>
            <p>To establish an authorization system, we need each user
            to having a role. Each role will determine which pages and
            actions can the user do.</p>
            <p>For our application, we are going to establish 3
            different roles:</p>
            <ul>
            <li>Unauthenticated users: can only visit the login and
            register pages.</li>
            <li>Users with the role <strong>‘user’</strong>: can edit
            their own user data in the <code>login_form.php</code>
            script, but cannot access to the <code>logins_list</code>
            page.</li>
            <li>Users with the role <strong>‘admin’</strong>: can acces
            to the <code>login_list.php</code> page and edit all the
            users data in <code>login_form.php</code>.</li>
            </ul>
            <p>Before coding, we need another field in our logins table
            to store the role. You can create it with phpMyAdmin or
            executing this SQL statement:</p>
            <div class="sourceCode" id="cb11"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cn">ALTER</span> <span class="cn">TABLE</span> <span class="st">`logins`</span> <span class="cn">ADD</span> <span class="st">`role`</span> <span class="cn">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">NULL</span> <span class="cf">DEFAULT</span> <span class="st">&#39;user&#39;</span><span class="ot">;</span> </span></code></pre></div>
            <p>The default role will be ‘user’. We are allowing null
            data, so the existing users will be equivalent to users with
            the role ‘user’.</p>
            <p>Go to the register form and create a new user for the
            admin role. Inspect your database and verify that has the
            role <code>'user'</code>. Change it to
            <code>'admin'</code>:</p>
            <figure>
            <img src="images/u09-05.png"
            alt="admin user in phpMyAdmin" />
            <figcaption aria-hidden="true">admin user in
            phpMyAdmin</figcaption>
            </figure>
            <p>Make sure you have another user with the role ‘user’. Now
            we can change the permissions in each page.</p>
            <p>In addition, we need a new property in our
            <code>Login</code> class with the name <code>'role'</code>
            and their setter and getter:</p>
            <div class="sourceCode" id="cb12"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">string</span> <span class="va">$role</span><span class="ot">;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">function</span> getRole()<span class="ot">:</span> <span class="dt">string</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">$this</span>-&gt;role<span class="ot">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">function</span> setRole(<span class="dt">string</span> <span class="va">$role</span>)<span class="ot">:</span> <span class="dt">void</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">$this</span>-&gt;role <span class="op">=</span> <span class="va">$role</span><span class="ot">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>Also, add the necessary code to the <code>LoginDao</code>
            class to store and retrieve the new field.</p>
            <p>In <code>logins_list.php</code>, simply add a check in
            the beginning of the script. If the user is authenticated
            but doesn’t has the admin role, redirect it to
            <code>login_form.php</code>. If the user is not
            authenticated, redirect to
            <code>login_access_form.php</code>:</p>
            <div class="sourceCode" id="cb13"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$user</span> <span class="op">=</span> <span class="cn">L</span>oginDao::select(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])<span class="ot">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">$userRole</span> <span class="op">=</span> <span class="va">$user</span>-&gt;getRole()<span class="ot">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="va">$userRole</span> <span class="op">!=</span> <span class="st">&#39;admin&#39;</span>){</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Has the role user</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">header</span>(<span class="st">&#39;Location: login_form.php&#39;</span>)<span class="ot">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//No authenticated user</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">header</span>(<span class="st">&#39;Location: login_access_form.php&#39;</span>)<span class="ot">;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>Go to the <code>login_form.php</code>. In this form the
            admin users can view and change all the users data, but the
            normal users only can view and change their own data. To do
            that, simply add a new condition to the code to check the
            user’s id (remember that a user can change the query string
            in the browser):</p>
            <div class="sourceCode" id="cb14"><pre
            class="sourceCode php"><code class="sourceCode php"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="kw">isset</span>(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$user</span> <span class="op">=</span> <span class="cn">L</span>oginDao::select(<span class="va">$_SESSION</span>[<span class="st">&#39;user_id&#39;</span>])<span class="ot">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">$userRole</span> <span class="op">=</span> <span class="va">$user</span>-&gt;getRole()<span class="ot">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="va">$userRole</span> <span class="op">!=</span> <span class="st">&#39;admin&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">$login</span>-&gt;getId() <span class="op">!=</span> <span class="va">$user</span>-&gt;getId()){</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Has the role user and the same id</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">header</span>(<span class="st">&#39;Location: login_form.php&#39;</span>)<span class="ot">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//No authenticated user</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">header</span>(<span class="st">&#39;Location: login_access_form.php&#39;</span>)<span class="ot">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
            <p>There are a lot of things to improve, like adding the
            possibility to change the user’s role or a mechanism to
            change the user’s password correctly. You can do it as
            exercise.</p>
            <p>Get the full app code in the <a
            href="https://github.com/ricardoprofe/login-security">GitHub
            repo</a>.</p>
        </main>
        

        <!--- Modal images -->

        <!-- The Modal -->
        <div id="myModal" class="modal">

            <!-- The Close Button -->
            <!--span class="close">&times;</span-->

            <!-- Modal Content (The Image) -->
            <img class="modal-content" id="img01">

            <!-- Modal Caption (Image Text) -->
            <div id="caption"></div>
        </div>

        <!-- End Modal Images -->

        <script>
            function ModalizeImages() {
                // Script basat en https://www.w3schools.com/howto/howto_css_modal_images.asp
                // PEr ampliar imatges en fer click

                // Get the modal
                var modal = document.getElementById("myModal");

                var modalImg = document.getElementById("img01");
                var captionText = document.getElementById("caption");

                // Get the image and insert it inside the modal - use its "alt" text as a caption
                //var img = document.getElementById("myImg");
                document.querySelectorAll("img").forEach((img => {
                        img.onclick = function() {
                            modal.style.display = "block";
                            modalImg.src = this.src;
                            captionText.innerHTML = this.alt;
                        }
                    }))
                    // Get the <span> element that closes the modal
                var span = document.getElementsByClassName("close")[0];

                // When the user clicks on <span> (x), close the modal
                //span.onclick = function() {
                myModal.onclick = function() {
                    modal.style.display = "none";
                }


            }


            function markItem(id) {
                // Restaurem format de tots
                document.querySelectorAll("#TOC a").forEach(function(item) {
                        //item.style.fontWeight = "300";
                        item.classList.remove("navItemSelected");
                    })
                    //item.style.color = "#ff0000";

                // Afegim format
                let items = document.querySelectorAll("#TOC a[href='#" + id + "']");
                items.forEach(function(item) {
                    //item.style.fontWeight = "bolder";
                    item.classList.add("navItemSelected");
                })

            }

            var observer = new IntersectionObserver(function(entries) {
                // isIntersecting is true when element and viewport are overlapping
                // isIntersecting is false when element and viewport don't overlap
                if (entries[0].isIntersecting === true) {
                    let id = entries[0].target.id;
                    markItem(id);
                }

            }, {
                threshold: [0]
            });

            window.addEventListener("load", function() {
                document.querySelectorAll("h1, h2, h3").forEach(function(item) {
                    observer.observe(item);
                });

                document.querySelectorAll("#TOC a").forEach(function(item) {
                    item.addEventListener("click", function(item) {
                        markItem(item.id);
                    })
                })

                // Fem modals totes les imatges
                ModalizeImages();
            })

            document.querySelector("#TOC").addEventListener("click", function(event) {
                let toc = event.target
                if (toc.offsetWidth > 10) {
                    toc.classList.add("minimizedToc");
                }
            })

            document.querySelector("#TOC").addEventListener("mouseover", function(event) {
                let toc = event.target
                if (toc.classList.contains("minimizedToc"))
                    toc.classList.remove("minimizedToc");
            })


            //item.style.color = "#ff0000";
        </script>
    </div>
</body>

</html>